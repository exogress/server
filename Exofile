---
version: 0.0.1
revision: 4
name: config1
mount_points:
  cctv:
    handlers:
      location:
        type: geo-ip
        priority: 2
        header: x-location
        rules:
          - filter:
              path: ["*"]
            action: try

      static:
        type: static-dir
        priority: 5
        dir: ./static
        default-action:
          kind:
        rules:
          - filter:
              path: ["assets", "*", "/(.+\.)(css|js)/"]
              methods:
                - GET
              protocol: http
            modify:
              path: [":1", ":2$1", ":2$0.$1"]
            action:
              kind: accept

          - filter:
              path: ["assets", "*"]
              methods:
                - GET
              protocol: http
            modify:
              path: [":1"]
            action:
              kind: throw
              error:
                name: static-not-found
                data:
                  message: "unknown asset"

          - filter:
              path: ["*"]
              protocol: ws
            action:
              kind: respond
              name: not-found

            # try - process by the handler and move on to the next handler on failure
            # accept - process by the handler and don't try next handlers if no response could be generated
            # nil - move on to the next rule. typically combined with rewrite
            # break - stop rules processing and move on to next handler
            # throw - finish the whole handlers chain and move to finalizer
            # respond - finish the whole processing chain with the desired response

      cam:
        type: proxy
        upstream: cam-hall2
        priority: 10

    # catch is executed when 1) no valid response is generated by handlers 2) error was thrown
    catch:
      # no handler properly processed the request
      not-handled:
        status-code: 500
        static-response: bad gateway
        data:
          custom: info

upstreams:
  flussonic:
    port: 8080

responses:
  static-not-found:
    application/html:
      content: "<html><body><h1>{{ this.message }}</h1></body>/html>"
      engine: handlebars

  not-found:
    application/html:
      content: |
        <html>
          <body>
            Not found
          </body>
        </html>

  server-error:
    application/html:
      path: "./static/index.html"
